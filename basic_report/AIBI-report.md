# AI for BI

Analyse data and provide a BI report including charts based on that data

We'll use CrewAI for the processing. This includes a Python interpreter which will be used to create the charts. You must have Docker installed locally to run the code automatically.

Running code generated by an LLM is potentially dangerous as there is n guarantee that the code wil be safe. Running the code in a Docker container, however, provides a sandbox for the code to run in and isolates it from the application code and local operating system.


Import the necessary libraries and set the LLM model (defaults to using OpenAI)


```python
from crewai import Agent, Task, Crew

llm = "gpt-4o-mini"
```


```python
files = [
    {
        'data_file_name':'sales_product_cat.csv',
        'chart_file_name': 'sales_product_summary.png',
        
    },
    {
        'data_file_name': 'monthly_sales.csv',
        'chart_file_name': 'monthly_sales.png',
    },
    {
        'data_file_name': 'sales_by_region.csv',
        'chart_file_name': 'sales_by_region.png',
    }
]
```


```python
import plotly.express as px
import pandas as pd

df = pd.read_csv(files[0]['data_file_name'])
fig = px.bar(df,  x="Product Name", y="Revenue ($)", 
             color="Product Category", template="plotly_white")
fig.write_image(files[0]['chart_file_name'])

df = pd.read_csv(files[1]['data_file_name'])
fig = px.bar(df,  x="Month", y="Total Revenue ($)", 
             template="plotly_white")
fig.write_image(files[1]['chart_file_name'])

df = pd.read_csv(files[2]['data_file_name'])
fig = px.bar(df,  x="Region", y="Total Revenue ($)", 
             color = "Top-Selling Product", template="plotly_white")
fig.write_image(files[2]['chart_file_name'])
```

Import the tools required to read and write files


```python
from crewai_tools import tool
from crewai_tools import FileReadTool, FileWriterTool

# Initialize the tool to read any files the agents knows or lean the path for
file_read_tool = FileReadTool()
file_writer_tool = FileWriterTool()
```

Set up the ``data_analysis_agent``


```python
# Define the agent
data_analysis_agent = Agent(
        role="Data Analyser",
        goal="""You aim is to read and analyse sales data. You should
                then write a report on sales performance that includes an executive summary.
                """,
        backstory="You are assigned to perform sales analysis for a company",
        tools=[file_read_tool, file_writer_tool],
        allow_delegation=False,
        llm=llm,
        allow_code_execution=False
    )

```


```python
write_report = Task(
    description=f"""Write_overview in Markdown for the sales data found in the following files:
                    {files[0]['data_file_name']} 
                    {files[1]['data_file_name']} 
                    {files[2]['data_file_name']} 

                    Add the following charts in the markdown text in the appropriate places:
                    {files[0]['chart_file_name']}
                    {files[1]['chart_file_name']} 
                    {files[2]['chart_file_name']} 
                    
                    Save the result in the file 'report.md'.
                    """,
    expected_output="""A markdown file""",
    agent=data_analysis_agent,
    tools=[file_read_tool, file_writer_tool]
)

# Define the crewwrite_overview
crew = Crew(
    agents=[data_analysis_agent],
    tasks=[write_report],
    verbose=True
)
result2 = crew.kickoff()
task_output = write_report.output
```

    2024-11-09 17:50:44,092 - 23520 - __init__.py-__init__:538 - WARNING: Overriding of current TracerProvider is not allowed
    

    [1m[95m# Agent:[00m [1m[92mData Analyser[00m
    [95m## Task:[00m [92mWrite_overview in Markdown for the sales data found in the following files:
                        sales_product_cat.csv 
                        monthly_sales.csv 
    
                        Add the following charts in the markdown text in the appropriate places:
                        sales_product_summary.png
                        monthly_sales.png 
                        
                        Save the result in the file 'report.md'.
                        [00m
    
    
    [1m[95m# Agent:[00m [1m[92mData Analyser[00m
    [95m## Thought:[00m [92mI need to gather information from the provided sales data files before I can write an overview in Markdown. I'll start by reading the content of the two CSV files: `sales_product_cat.csv` and `monthly_sales.csv`.[00m
    [95m## Using tool:[00m [92mRead a file's content[00m
    [95m## Tool Input:[00m [92m
    "{\"file_path\": \"sales_product_cat.csv\"}"[00m
    [95m## Tool Output:[00m [92m
    Product Category,Product Name,Units Sold,Revenue ($),% Change (Month-over-Month)
    Electronics,Smart TV,1500,450000,+10%
    Electronics,Laptop,1200,840000,+5%
    Electronics,Smartphone,2000,1200000,-2%
    Home Appliances,Refrigerator,700,350000,+8%
    Home Appliances,Washing Machine,500,250000,-3%
    Home Appliances,Microwave,900,135000,+15%
    Furniture,Sofa,300,90000,+20%
    Furniture,Dining Table,150,75000,+12%
    Furniture,Bed Frame,250,125000,+7%
    [00m
    
    
    [1m[95m# Agent:[00m [1m[92mData Analyser[00m
    [95m## Using tool:[00m [92mRead a file's content[00m
    [95m## Tool Input:[00m [92m
    "{\"file_path\": \"monthly_sales.csv\"}"[00m
    [95m## Tool Output:[00m [92m
    Month,Total Units Sold,Total Revenue ($),% Change (Month-over-Month)
    January,10000,3500000,-
    February,10500,3675000,+5%
    March,11000,3850000,+4.8%
    April,10800,3780000,-1.8%
    May,11500,4025000,+6.5%
    June,11300,3955000,-1.7%
    July,12000,4200000,+6.2%
    August,11800,4130000,-1.7%
    [00m
    
    
    [1m[95m# Agent:[00m [1m[92mData Analyser[00m
    [95m## Thought:[00m [92mThought: I have gathered the necessary data from both CSV files. Now, I will create an overview in Markdown format with sections for the product category sales summary and monthly sales summary, and I will include the mentioned charts.
    Here is the Markdown content I will create:
    ```markdown
    # Sales Data Overview
    ## Product Category Sales Summary
    | Product Category     | Product Name       | Units Sold | Revenue ($) | % Change (Month-over-Month) |
    |----------------------|--------------------|------------|-------------|-------------------------------|
    | Electronics          | Smart TV           | 1500       | 450000      | +10%                          |
    | Electronics          | Laptop             | 1200       | 840000      | +5%                           |
    | Electronics          | Smartphone         | 2000       | 1200000     | -2%                           |
    | Home Appliances      | Refrigerator       | 700        | 350000      | +8%                           |
    | Home Appliances      | Washing Machine     | 500        | 250000      | -3%                           |
    | Home Appliances      | Microwave          | 900        | 135000      | +15%                          |
    | Furniture            | Sofa               | 300        | 90000       | +20%                          |
    | Furniture            | Dining Table       | 150        | 75000       | +12%                          |
    | Furniture            | Bed Frame          | 250        | 125000      | +7%                           |
    ![Product Category Sales Summary](sales_product_summary.png)
    ## Monthly Sales Summary
    | Month     | Total Units Sold | Total Revenue ($) | % Change (Month-over-Month) |
    |-----------|------------------|--------------------|-------------------------------|
    | January   | 10000            | 3500000            | -                             |
    | February  | 10500            | 3675000            | +5%                           |
    | March     | 11000            | 3850000            | +4.8%                         |
    | April     | 10800            | 3780000            | -1.8%                         |
    | May       | 11500            | 4025000            | +6.5%                         |
    | June      | 11300            | 3955000            | -1.7%                         |
    | July      | 12000            | 4200000            | +6.2%                         |
    | August    | 11800            | 4130000            | -1.7%                         |
    ![Monthly Sales Summary](monthly_sales.png)
    ```
    Now I will save this Markdown content to the file 'report.md'.[00m
    [95m## Using tool:[00m [92mFile Writer Tool[00m
    [95m## Tool Input:[00m [92m
    "{\"filename\": \"report.md\", \"overwrite\": \"yes\", \"content\": \"# Sales Data Overview\\n\\n## Product Category Sales Summary\\n\\n| Product Category     | Product Name       | Units Sold | Revenue ($) | % Change (Month-over-Month) |\\n|----------------------|--------------------|------------|-------------|-------------------------------|\\n| Electronics          | Smart TV           | 1500       | 450000      | +10%                          |\\n| Electronics          | Laptop             | 1200       | 840000      | +5%                           |\\n| Electronics          | Smartphone         | 2000       | 1200000     | -2%                           |\\n| Home Appliances      | Refrigerator       | 700        | 350000      | +8%                           |\\n| Home Appliances      | Washing Machine     | 500        | 250000      | -3%                           |\\n| Home Appliances      | Microwave          | 900        | 135000      | +15%                          |\\n| Furniture            | Sofa               | 300        | 90000       | +20%                          |\\n| Furniture            | Dining Table       | 150        | 75000       | +12%                          |\\n| Furniture            | Bed Frame          | 250        | 125000      | +7%                           |\\n\\n![Product Category Sales Summary](sales_product_summary.png)\\n\\n## Monthly Sales Summary\\n\\n| Month     | Total Units Sold | Total Revenue ($) | % Change (Month-over-Month) |\\n|-----------|------------------|--------------------|-------------------------------|\\n| January   | 10000            | 3500000            | -                             |\\n| February  | 10500            | 3675000            | +5%                           |\\n| March     | 11000            | 3850000            | +4.8%                         |\\n| April     | 10800            | 3780000            | -1.8%                         |\\n| May       | 11500            | 4025000            | +6.5%                         |\\n| June      | 11300            | 3955000            | -1.7%                         |\\n| July      | 12000            | 4200000            | +6.2%                         |\\n| August    | 11800            | 4130000            | -1.7%                         |\\n\\n![Monthly Sales Summary](monthly_sales.png)\"}"[00m
    [95m## Tool Output:[00m [92m
    Content successfully written to report.md
    
    
    You ONLY have access to the following tools, and should NEVER make up tools that are not listed here:
    
    Tool Name: Read a file's content
    Tool Description: Read a file's content(file_path: 'string') - A tool that can be used to read a file's content. file_path: 'Mandatory file full path to read the file'
    Tool Arguments: {'file_path': {'description': 'Mandatory file full path to read the file', 'type': 'str'}}
    Tool Name: File Writer Tool
    Tool Description: File Writer Tool(filename: 'string', overwrite: 'string', content: 'string') - A tool to write content to a specified file. Accepts filename, content, and optionally a directory path and overwrite flag as input. 
    Tool Arguments: {'filename': {'description': None, 'type': 'str'}, 'directory': {'description': None, 'type': 'Optional'}, 'overwrite': {'description': None, 'type': 'str'}, 'content': {'description': None, 'type': 'str'}}
    
    Use the following format:
    
    Thought: you should always think about what to do
    Action: the action to take, only one name of [Read a file's content, File Writer Tool], just the name, exactly as it's written.
    Action Input: the input to the action, just a simple python dictionary, enclosed in curly braces, using " to wrap keys and values.
    Observation: the result of the action
    
    Once all necessary information is gathered:
    
    Thought: I now know the final answer
    Final Answer: the final answer to the original input question
    [00m
    
    
    [1m[95m# Agent:[00m [1m[92mData Analyser[00m
    [95m## Final Answer:[00m [92m
    ```markdown
    # Sales Data Overview
    
    ## Product Category Sales Summary
    
    | Product Category     | Product Name       | Units Sold | Revenue ($) | % Change (Month-over-Month) |
    |----------------------|--------------------|------------|-------------|-------------------------------|
    | Electronics          | Smart TV           | 1500       | 450000      | +10%                          |
    | Electronics          | Laptop             | 1200       | 840000      | +5%                           |
    | Electronics          | Smartphone         | 2000       | 1200000     | -2%                           |
    | Home Appliances      | Refrigerator       | 700        | 350000      | +8%                           |
    | Home Appliances      | Washing Machine     | 500        | 250000      | -3%                           |
    | Home Appliances      | Microwave          | 900        | 135000      | +15%                          |
    | Furniture            | Sofa               | 300        | 90000       | +20%                          |
    | Furniture            | Dining Table       | 150        | 75000       | +12%                          |
    | Furniture            | Bed Frame          | 250        | 125000      | +7%                           |
    
    ![Product Category Sales Summary](sales_product_summary.png)
    
    ## Monthly Sales Summary
    
    | Month     | Total Units Sold | Total Revenue ($) | % Change (Month-over-Month) |
    |-----------|------------------|--------------------|-------------------------------|
    | January   | 10000            | 3500000            | -                             |
    | February  | 10500            | 3675000            | +5%                           |
    | March     | 11000            | 3850000            | +4.8%                         |
    | April     | 10800            | 3780000            | -1.8%                         |
    | May       | 11500            | 4025000            | +6.5%                         |
    | June      | 11300            | 3955000            | -1.7%                         |
    | July      | 12000            | 4200000            | +6.2%                         |
    | August    | 11800            | 4130000            | -1.7%                         |
    
    ![Monthly Sales Summary](monthly_sales.png)
    ```[00m
    
    
    


```python
#print(f"Task Description: {result.description}")
#print(f"Task Summary: {result.summary}")
print(f"Raw Output: {result2.raw}")
```

    Raw Output: ```markdown
    # Sales Data Overview
    
    ## Product Category Sales Summary
    
    | Product Category     | Product Name       | Units Sold | Revenue ($) | % Change (Month-over-Month) |
    |----------------------|--------------------|------------|-------------|-------------------------------|
    | Electronics          | Smart TV           | 1500       | 450000      | +10%                          |
    | Electronics          | Laptop             | 1200       | 840000      | +5%                           |
    | Electronics          | Smartphone         | 2000       | 1200000     | -2%                           |
    | Home Appliances      | Refrigerator       | 700        | 350000      | +8%                           |
    | Home Appliances      | Washing Machine     | 500        | 250000      | -3%                           |
    | Home Appliances      | Microwave          | 900        | 135000      | +15%                          |
    | Furniture            | Sofa               | 300        | 90000       | +20%                          |
    | Furniture            | Dining Table       | 150        | 75000       | +12%                          |
    | Furniture            | Bed Frame          | 250        | 125000      | +7%                           |
    
    ![Product Category Sales Summary](sales_product_summary.png)
    
    ## Monthly Sales Summary
    
    | Month     | Total Units Sold | Total Revenue ($) | % Change (Month-over-Month) |
    |-----------|------------------|--------------------|-------------------------------|
    | January   | 10000            | 3500000            | -                             |
    | February  | 10500            | 3675000            | +5%                           |
    | March     | 11000            | 3850000            | +4.8%                         |
    | April     | 10800            | 3780000            | -1.8%                         |
    | May       | 11500            | 4025000            | +6.5%                         |
    | June      | 11300            | 3955000            | -1.7%                         |
    | July      | 12000            | 4200000            | +6.2%                         |
    | August    | 11800            | 4130000            | -1.7%                         |
    
    ![Monthly Sales Summary](monthly_sales.png)
    ```
    

# Sales Performance Overview

## Sales Data Summary

### Product Category Sales
| Product Category      | Product Name       | Units Sold | Revenue ($) | % Change (Month-over-Month) |
|----------------------|--------------------|------------|-------------|------------------------------|
| Electronics          | Smart TV           | 1500       | 450000      | +10%                         |
| Electronics          | Laptop             | 1200       | 840000      | +5%                          |
| Electronics          | Smartphone         | 2000       | 1200000     | -2%                          |
| Home Appliances      | Refrigerator       | 700        | 350000      | +8%                          |
| Home Appliances      | Washing Machine     | 500        | 250000      | -3%                          |
| Home Appliances      | Microwave          | 900        | 135000      | +15%                         |
| Furniture            | Sofa               | 300        | 90000       | +20%                         |
| Furniture            | Dining Table       | 150        | 75000       | +12%                         |
| Furniture            | Bed Frame          | 250        | 125000      | +7%                          |

### Monthly Sales Overview
| Month      | Total Units Sold | Total Revenue ($) | % Change (Month-over-Month) |
|------------|------------------|--------------------|------------------------------|
| January    | 10000            | 3500000            | -                            |
| February   | 10500            | 3675000            | +5%                          |
| March      | 11000            | 3850000            | +4.8%                        |
| April      | 10800            | 3780000            | -1.8%                        |
| May        | 11500            | 4025000            | +6.5%                        |
| June       | 11300            | 3955000            | -1.7%                        |
| July       | 12000            | 4200000            | +6.2%                        |
| August     | 11800            | 4130000            | -1.7%                        |

## Charts

![Product Summary](./sales_product_summary.png)

![Monthly Sales](./monthly_sales.png)

